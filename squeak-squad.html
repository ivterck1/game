<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squeak Squad - Big Ducks Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #222;
            font-family: 'Arial Black', sans-serif;
            overflow: hidden;
            touch-action: none;
        }
        #game-container {
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>
    <div id="game-container"></div>

    <script>
    // ============================================
    // SISTEMA DE AUDIO
    // ============================================
    const gameInstance = { audioManager: null };
    class AudioManager {
        constructor() { this.ctx = null; this.initialized = false; }
        async init() {
            if (this.initialized) return;
            try {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                if (this.ctx.state === 'suspended') await this.ctx.resume();
                this.initialized = true;
            } catch (e) { console.warn("Audio error", e); }
        }
        playTone(freq, type = 'sine') {
            if (!this.initialized) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.3);
        }
    }
    gameInstance.audioManager = new AudioManager();

    // ============================================
    // ESCENA TÍTULO
    // ============================================
    class TitleScene extends Phaser.Scene {
        constructor() { super({ key: 'TitleScene' }); }
        
        preload() { 
            // Cargar los 8 patos
            for(let i=1; i<=8; i++) {
                this.load.image('pato'+i, 'pato'+i+'.png');
            }
            // Cargar fondo
            this.load.image('fondo_patos', 'fondo_patos.png');
        }

        create() {
            try {
                const bg = this.add.image(400, 300, 'fondo_patos');
                const scaleX = 800 / bg.width;
                const scaleY = 600 / bg.height;
                const scale = Math.max(scaleX, scaleY);
                bg.setScale(scale).setScrollFactor(0);
            } catch(e) {
                this.add.rectangle(400, 300, 800, 600, 0xFFA500);
            }

            this.add.rectangle(400, 300, 800, 600, 0x000000, 0.6);

            const title = this.add.text(400, 200, 'SQUEAK\nSQUAD', {
                fontSize: '80px', fontFamily: 'Arial Black', color: '#FFF',
                align: 'center', stroke: '#000', strokeThickness: 10
            }).setOrigin(0.5);

            this.tweens.add({
                targets: title, scale: 1.05, duration: 1500, yoyo: true, repeat: -1, ease: 'Sine.easeInOut'
            });

            const btn = this.add.container(400, 450);
            const btnBg = this.add.rectangle(0, 0, 300, 80, 0x00FF88).setStrokeStyle(4, 0xFFFFFF);
            const btnTxt = this.add.text(0, 0, 'JUGAR', { fontSize: '40px', fontFamily: 'Arial Black', color: '#000' }).setOrigin(0.5);
            btn.add([btnBg, btnTxt]);
            
            this.tweens.add({ targets: btn, scale: 1.05, duration: 800, yoyo: true, repeat: -1 });

            btn.setInteractive(new Phaser.Geom.Rectangle(-150, -40, 300, 80), Phaser.Geom.Rectangle.Contains);
            btn.once('pointerdown', () => {
                gameInstance.audioManager.init();
                this.scene.start('GameScene');
            });
        }
    }

    // ============================================
    // ESCENA DE JUEGO
    // ============================================
    class GameScene extends Phaser.Scene {
        constructor() { super({ key: 'GameScene' }); }

        create() {
            const bg = this.add.graphics();
            bg.fillGradientStyle(0x006994, 0x006994, 0x003366, 0x003366, 1);
            bg.fillRect(0, 0, 800, 600);
            
            // Burbujas
            for(let i=0; i<20; i++) {
                const x = Phaser.Math.Between(0, 800);
                const y = Phaser.Math.Between(0, 600);
                const r = Phaser.Math.Between(5, 20);
                const bubble = this.add.circle(x, y, r, 0xFFFFFF, 0.1);
                this.tweens.add({
                    targets: bubble, y: y - 100, alpha: 0,
                    duration: Phaser.Math.Between(2000, 5000),
                    repeat: -1, yoyo: false
                });
            }

            this.sequence = [];
            this.playerSequence = [];
            this.inputBlocked = true;
            this.round = 0;

            this.createRandomDucks();
            
            this.statusText = this.add.text(400, 100, 'PREPÁRATE', {
                fontSize: '50px', fontFamily: 'Arial Black', color: '#FFF',
                stroke: '#003366', strokeThickness: 8, shadow: { blur: 10, color: '#000', fill: true}
            }).setOrigin(0.5);

            this.time.delayedCall(1000, () => this.startRound());
        }

        createRandomDucks() {
            const colors = [0xFF0055, 0x00AAFF, 0x00FF66, 0xFFAA00]; 
            const freqs = [300, 400, 500, 600];
            const xPositions = [160, 320, 480, 640]; // Centros de columna
            
            let availableDucks = [1, 2, 3, 4, 5, 6, 7, 8];
            availableDucks.sort(() => Math.random() - 0.5);
            let selectedDucks = availableDucks.slice(0, 4);

            this.ducks = [];

            xPositions.forEach((x, i) => {
                const container = this.add.container(x, 350);

                // 1. LUZ TRASERA (Más grande y difusa, sin borde)
                const glow = this.add.circle(0, -20, 85, colors[i], 0.6)
                    .setVisible(false)
                    .setBlendMode(Phaser.BlendModes.ADD);

                // 2. PATO GIGANTE
                const duckId = 'pato' + selectedDucks[i];
                const duckSprite = this.add.image(0, 60, duckId).setOrigin(0.5, 1);
                
                // --- AJUSTE DE TAMAÑO GIGANTE ---
                // 145px de ancho deja poco espacio entre ellos, se verán enormes
                const targetWidth = 200; 
                const scaleFactor = targetWidth / duckSprite.width;
                duckSprite.setScale(scaleFactor);

                // Agregamos solo glow y pato (SIN ARO)
                container.add([glow, duckSprite]);
                
                container.glow = glow;
                container.duck = duckSprite;
                container.freq = freqs[i];

                // 3. ÁREA DE CLICK (Más alta para cubrir al pato grande)
                const hitArea = this.add.rectangle(0, -30, 150, 190, 0x000000, 0); 
                container.add(hitArea);
                hitArea.setInteractive({ useHandCursor: true });
                
                hitArea.on('pointerdown', () => this.handleInput(i));
                // Animación hover sutil
                hitArea.on('pointerover', () => duckSprite.y = 55);
                hitArea.on('pointerout', () => duckSprite.y = 60);

                this.ducks.push(container);
            });
        }

        startRound() {
            this.round++;
            this.statusText.setText('RONDA ' + this.round);
            this.sequence.push(Phaser.Math.Between(0, 3));
            this.playerSequence = [];
            this.time.delayedCall(800, () => this.playSequence());
        }

        playSequence() {
            this.inputBlocked = true;
            let i = 0;
            const speed = Math.max(300, 800 - (this.round * 40));

            const playNext = () => {
                if (i >= this.sequence.length) {
                    this.statusText.setText('¡TU TURNO!');
                    this.inputBlocked = false;
                    return;
                }
                this.activateDuck(this.sequence[i]);
                i++;
                this.time.delayedCall(speed, playNext);
            };
            playNext();
        }

        activateDuck(index) {
            const item = this.ducks[index];
            gameInstance.audioManager.playTone(item.freq);
            
            // Visual: Glow aparece suavemente
            item.glow.setVisible(true);
            item.glow.setAlpha(0.8);
            this.tweens.add({
                targets: item.glow, alpha: 0, duration: 500,
                onComplete: () => item.glow.setVisible(false)
            });

            // Visual: Salto "Squash"
            this.tweens.add({
                targets: item.duck, scaleY: item.duck.scaleY * 1.2, scaleX: item.duck.scaleX * 0.85, y: 30,
                duration: 100, yoyo: true, ease: 'Quad.easeOut'
            });
        }

        handleInput(index) {
            if (this.inputBlocked) return;
            this.activateDuck(index);
            const expected = this.sequence[this.playerSequence.length];
            if (index === expected) {
                this.playerSequence.push(index);
                if (this.playerSequence.length === this.sequence.length) {
                    this.inputBlocked = true;
                    this.statusText.setText('¡BIEN!');
                    this.time.delayedCall(1000, () => this.startRound());
                }
            } else {
                this.scene.start('GameOverScene', { score: this.round });
            }
        }
    }

    // ============================================
    // GAME OVER
    // ============================================
    class GameOverScene extends Phaser.Scene {
        constructor() { super({ key: 'GameOverScene' }); }
        create(data) {
            // Fondo
            try {
                const bg = this.add.image(400, 300, 'fondo_patos'); // Corregido typo
                const scaleX = 800 / bg.width;
                const scaleY = 600 / bg.height;
                const scale = Math.max(scaleX, scaleY);
                bg.setScale(scale);
            } catch(e) {
                this.add.rectangle(400, 300, 800, 600, 0x222);
            }

            this.add.rectangle(400, 300, 800, 600, 0x330000, 0.8);

            this.add.text(400, 200, 'GAME OVER', { 
                fontSize: '64px', fontFamily: 'Arial Black', color: '#FF4444', stroke: '#FFF', strokeThickness: 4 
            }).setOrigin(0.5);
            
            this.add.text(400, 300, 'Ronda: ' + data.score, { 
                fontSize: '40px', color: '#FFF', fontFamily: 'Arial'
            }).setOrigin(0.5);
            
            const btn = this.add.text(400, 450, 'REINTENTAR', { 
                fontSize: '28px', backgroundColor: '#FFF', color: '#000', padding: {x:20, y:10}, fontFamily: 'Arial Black'
            }).setOrigin(0.5);
            
            btn.setInteractive({ useHandCursor: true });
            btn.on('pointerdown', () => this.scene.start('GameScene'));
        }
    }

    const config = {
        type: Phaser.AUTO,
        scale: {
            mode: Phaser.Scale.FIT,
            autoCenter: Phaser.Scale.CENTER_BOTH,
            width: 800,
            height: 600
        },
        scene: [TitleScene, GameScene, GameOverScene]
    };

    new Phaser.Game(config);
    </script>
</body>
</html>